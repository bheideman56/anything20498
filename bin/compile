#!/bin/sh

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

BP_DIR="$(dirname "$(dirname "$0")")"

[ ! -d "$CACHE_DIR" ] && mkdir -p "$CACHE_DIR"

mkdir -p "$BUILD_DIR/bin"

cp "$BP_DIR/scripts/schema-update" "$CACHE_DIR"

indent() {
	sed -u 's/^/       /'
}

export_env_dir() {
	env_dir="$1"
	whitelist_regex=${2:-''}
	blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
	if [ -d "$env_dir" ]; then
		for e in $(ls "$env_dir"); do
			echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
			export "$e=$(cat "$env_dir"/"$e")"
			:
		done
	fi
}

echo "-----> Exporting configuration variables to environment"
export_env_dir "$ENV_DIR"

if [ ! -s "$BUILD_DIR/messenger.json" ]; then
	echo "messenger.json is empty"
	exit 1
else
	echo "-----> Modifying messenger.json"
	"$CACHE_DIR"/schema-update "$BUILD_DIR"/messenger.json
fi

echo "-----> Installing Ansible Galaxy role"
ansible-galaxy install --roles-path="$BUILD_DIR" mako-ai.facebook-messenger > /dev/null

echo "-----> Creating Ansible inventory file"
printf 'localhost\n' | tee "$BUILD_DIR/inventory" > /dev/null

echo "-----> Creating Ansible playbook"
tee "$BUILD_DIR/site.yml" > /dev/null << EOF
---

- connection: local
  gather_facts: yes
  hosts: all
  tasks:
    - debug:
        msg: "Using callback URL: {{ graph_subscription_callback_url }}"

    - import_role:
        name: mako-ai.facebook-messenger

    # https://devcenter.heroku.com/articles/platform-api-reference#config-vars-update
    - name: Write the application access token and application verify token to Heroku configuration variables
      uri:
        body: |
          {
            "ACCESS_TOKEN": "{{ user.access_token }}",
            "FACEBOOK_USER_ID": "{{ user.id }}"
          }
        body_format: json
        headers:
          Accept: application/vnd.heroku+json; version=3
          Authorization: Bearer {{ ansible_env.HEROKU_API_KEY }}
          Content-Type: application/json
        method: PATCH
        return_content: yes
        url: https://api.heroku.com/apps/{{ ansible_env.HEROKU_APP_NAME }}/config-vars
EOF

postdeploy="$BUILD_DIR/bin/postdeploy.sh"

cat > "$postdeploy" << EOF
#!/usr/bin/env bash

unset PYTHONHOME
unset PYTHONPATH

ansible-playbook \
	--extra-vars "@$HOME/messenger.json" \
	--inventory "$HOME"/inventory \
	"$HOME"/site.yml
EOF

chmod +x "$postdeploy"

prpredestroy="$BUILD_DIR/bin/pr-predestroy.sh"

cat > "$prpredestroy" << EOF
#!/usr/bin/env bash

unset PYTHONHOME
unset PYTHONPATH

ansible-playbook \
	--extra-vars "{'user': {'id': '\$FACEBOOK_USER_ID'}}" \
	--inventory "$HOME"/inventory \
	--tags destroy \
	"$HOME"/site.yml
EOF

chmod +x "$prpredestroy"

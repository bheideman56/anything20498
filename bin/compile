#!/bin/sh

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

BP_DIR="$(dirname "$(dirname "$0")")"

[ ! -d "$CACHE_DIR" ] && mkdir -p "$CACHE_DIR"

mkdir -p "$BUILD_DIR/bin"

cp "$BP_DIR/scripts/schema-update" "$CACHE_DIR"

echo "-----> Listing contents of $ENV_DIR"
ls -al "$ENV_DIR"

indent() {
	sed -u 's/^/       /'
}

export_env_dir() {
  env_dir="$1"
  whitelist_regex=${2:-''}
  blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls "$env_dir"); do
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      export "$e=$(cat "$env_dir"/"$e")"
      :
    done
  fi
}

echo "-----> Found messenger.json"

echo "Exporting configuration variables to environment" | indent
export_env_dir "$ENV_DIR"

echo "$HEROKU_APP_NAME"

if [ ! -s "$BUILD_DIR/messenger.json" ]; then
	echo "messenger.json is empty"
	exit 1
else
	echo "Modifying messenger.json"
	"$CACHE_DIR"/schema-update "$BUILD_DIR"/messenger.json
fi | indent

ansible-galaxy install --roles-path="$BUILD_DIR" mako-ai.facebook-messenger | indent

printf 'localhost\n' | tee "$BUILD_DIR/inventory"

tee "$BUILD_DIR/site.yml" << EOF
---

- connection: local
  gather_facts: yes
  hosts: all
  tasks:
    - import_role:
        name: mako-ai.facebook-messenger

    # https://devcenter.heroku.com/articles/platform-api-reference#config-vars-update
    - name: Write the application access token and application verify token to Heroku configuration variables
      uri:
        body: |
          {
            "ACCESS_TOKEN": "{{ user.access_token }}",
            "FACEBOOK_USER_ID": "{{ user.id }}"
          }
        body_format: json
        headers:
          Accept: application/vnd.heroku+json; version=3
          Authorization: Bearer {{ ansible_env.HEROKU_API_KEY }}
          Content-Type: application/json
        method: PATCH
        return_content: yes
        url: https://api.heroku.com/apps/{{ ansible_env.HEROKU_APP_NAME }}/config-vars
EOF

postdeploy="$BUILD_DIR/bin/postdeploy.sh"

cat > "$postdeploy" << EOF
unset PYTHONHOME
unset PYTHONPATH

ansible-playbook \
--extra-vars "@/app/messenger.json" \
--inventory /app/inventory \
/app/site.yml
EOF

chmod +x "$postdeploy"

prpredestroy="$BUILD_DIR/bin/pr-predestroy.sh"

cat > "$prpredestroy" << EOF
unset PYTHONHOME
unset PYTHONPATH

ansible-playbook \
--extra-vars '{"user": {"id": "$FACEBOOK_USER_ID"}}' \
--inventory /app/inventory \
--tags destroy \
/app/site.yml
EOF

chmod +x "$prpredestroy"
